<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book Details - OceanBooks</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* same CSS — unchanged */
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="main.html" class="nav-brand">OceanBooks</a>
    <a href="main.html" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Books</a>
  </nav>

  <div class="container" id="book-content">
    <div class="book-thumbnail"><i class="fas fa-spinner fa-spin fa-2x"></i></div>
    <div class="book-details"><p>Loading book details...</p></div>
  </div>

  <footer class="footer">
    <div class="footer-links">
      <a href="main.html">BOOKS</a>
      <a href="index.html#about">About</a>
      <a href="index.html#contact">Contact</a>
      <a href="admin/admin.html">Admin</a>
    </div>
    <div class="copyright">&copy; 2025 OceanBooks. All rights reserved.</div>
  </footer>

  <script>
    const API_BASE = "https://new-m97f.onrender.com";

    async function fetchBookDetails() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) return;

      try {
        const res = await fetch(`${API_BASE}/api/books`);
        const books = await res.json();
        const book = books.find(b => b.id == id);
        if (!book) {
          document.getElementById('book-content').innerHTML = '<p>Book not found.</p>';
          return;
        }

        document.getElementById('book-content').innerHTML = `
          <div class="book-thumbnail">
            <img src="${book.thumbnail_path}" alt="${book.title}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/29/29302.png';">
          </div>

          <div class="book-details">
            <div class="book-category">${book.category}</div>
            <div class="book-title">${book.title}</div>
            <div class="book-author">by ${book.author}</div>
            <div class="book-description">${book.description || "No description available."}</div>

            <div class="meta">
              <div class="meta-item"><div class="meta-label">File Size</div><div class="meta-value">${book.file_size}</div></div>
              <div class="meta-item"><div class="meta-label">Downloads</div><div class="meta-value">${book.downloads}</div></div>
              <div class="meta-item"><div class="meta-label">Uploaded</div><div class="meta-value">${new Date(book.upload_date).toLocaleDateString()}</div></div>
              <div class="meta-item"><div class="meta-label">File Name</div><div class="meta-value">${book.file_name}</div></div>
            </div>

            <div class="download-section">
              <button class="download-btn" id="download-btn"><i class="fas fa-download"></i> Download Book</button>
              <div class="progress-container" id="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
              </div>
              <div class="progress-text" id="progress-text"></div>
            </div>
          </div>
        `;

        document.getElementById('download-btn').addEventListener('click', async () => {
          const btn = document.getElementById('download-btn');
          const progress = document.getElementById('progress-text');
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';
          try {
            const response = await fetch(`${API_BASE}/api/books/${book.id}/download`);
            if (!response.ok) throw new Error('Failed to download file.');
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = book.file_name;
            a.click();
            URL.revokeObjectURL(url);
            btn.innerHTML = '<i class="fas fa-check"></i> Downloaded ✅';
            progress.innerHTML = '<span style="color:#00ffaa;">Download Complete</span>';
          } catch (e) {
            btn.innerHTML = 'Download Book';
            progress.textContent = 'Download failed ❌';
          }
        });
      } catch (err) {
        document.getElementById('book-content').innerHTML = `<p>Error loading details: ${err}</p>`;
      }
    }

    fetchBookDetails();
  </script>
</body>
</html>
